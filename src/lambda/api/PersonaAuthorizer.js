"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PersonaAuthorizer = void 0;
const _ = require("lodash");
const talis_node_1 = require("talis-node");
// Constants used by parseMethodArn:
//
// Example MethodARN:
//   "arn:aws:execute-api:<Region id>:<Account id>:<API id>/<Stage>/<Method>/<Resource path>"
// Method ARN Index:  0   1   2           3           4            5
// API Gateway ARN Index:                                          0        1       2        3
//
//
const ARN_INDEX = 0;
const AWS_INDEX = 1;
const EXECUTE_INDEX = 2;
const REGION_INDEX = 3;
const ACCOUNT_ID_INDEX = 4;
const API_GATEWAY_ARN_INDEX = 5;
const METHOD_ARN_INDEXES = [
    ARN_INDEX,
    AWS_INDEX,
    EXECUTE_INDEX,
    REGION_INDEX,
    ACCOUNT_ID_INDEX,
    API_GATEWAY_ARN_INDEX,
];
const API_ID_INDEX = 0;
const STAGE_INDEX = 1;
const METHOD_INDEX = 2;
const RESOURCE_PATH_INDEX = 3;
const API_GATEWAY_ARN_INDEXES = [
    API_ID_INDEX,
    STAGE_INDEX,
    METHOD_INDEX,
    RESOURCE_PATH_INDEX,
];
class PersonaAuthorizer {
    constructor(event, context) {
        this.event = event;
        this.context = context;
        this.personaClient = undefined;
    }
    async handle() {
        var _a;
        console.log("Received event", this.event);
        if (!((_a = this.event) === null || _a === void 0 ? void 0 : _a.headers) || this.event.headers["authorization"] == null) {
            console.log("Missing auth token");
            return this.context.fail("Unauthorized");
        }
        const parsedMethodArn = this.parseMethodArn(this.event.routeArn);
        console.log(`Parsed Method Arn: ${JSON.stringify(parsedMethodArn)}`);
        const scope = this.getScope(parsedMethodArn);
        console.log(`Method has scope: ${scope}`);
        let validationOpts = {
            token: _.replace(this.event.headers["authorization"], "Bearer", "").trim(),
        };
        if (scope != null) {
            validationOpts = _.merge(validationOpts, { scope });
        }
        console.log(`Validation ops: ${JSON.stringify(validationOpts)}`);
        console.log("validating token against request", `${parsedMethodArn.resourcePath}`);
        if (!validationOpts.token || validationOpts.token.length === 0) {
            console.log("token missing");
            return this.context.fail("Unauthorized");
        }
        try {
            const token = await this.validateToken(validationOpts);
            const success = {
                isAuthorized: true,
                context: {
                    clientId: token["sub"],
                },
            };
            return this.context.succeed(success);
        }
        catch (err) {
            console.log("token validation failed", err);
            const error = err;
            if (error.error === talis_node_1.persona.errorTypes.INSUFFICIENT_SCOPE) {
                const insufficientScope = {
                    isAuthorized: false,
                    context: {
                        description: "Insufficient Scope",
                        clientId: (error === null || error === void 0 ? void 0 : error.token) ? error.token["sub"] : "",
                    },
                };
                return this.context.succeed(insufficientScope);
            }
            const failure = {
                isAuthorized: false,
                context: {
                    clientId: (error === null || error === void 0 ? void 0 : error.token) ? error.token["sub"] : "",
                },
            };
            return this.context.succeed(failure);
        }
    }
    validateToken(validationOpts) {
        const client = this.getPersonaClient();
        return new Promise(function (resolve, reject) {
            client.validateToken(validationOpts, (error, ok, decodedToken) => {
                if (error) {
                    reject({
                        error: error,
                        token: decodedToken,
                    });
                }
                resolve(decodedToken);
            });
        });
    }
    /**
     * Break down an API gateway method ARN into it's constituent parts.
     * Method ARNs take the following format:
     *
     *   arn:aws:execute-api:<Region id>:<Account id>:<API id>/<Stage>/<Method>/<Resource path>
     *
     * e.g:
     *
     *   arn:aws:execute-api:eu-west-1:123:abc/development/GET/2/works
     *
     * @param methodArn {string} The method ARN provided by the event handed to a Lambda function
     * @returns {{
     *   method: string,
     *   resourcePath: string,
     *   apiOptions: {
     *     region: string,
     *     restApiId: string,
     *     stage: string
     *   },
     *   awsAccountId: string
     *   }}
     */
    parseMethodArn(methodArn) {
        const methodArnParts = methodArn.split(":");
        console.log(`Method ARN Parts: ${JSON.stringify(methodArnParts)}`);
        let apiGatewayArn = methodArnParts[API_GATEWAY_ARN_INDEX];
        // If the split created more than the expected number of parts, then the
        // apiGatewayArn must have had one or more :'s in it. Recreate the apiGateway arn.
        for (let index = METHOD_ARN_INDEXES.length; index < methodArnParts.length; index += 1) {
            apiGatewayArn += `:${methodArnParts[index]}`;
        }
        const apiGatewayArnParts = apiGatewayArn.split("/");
        console.log(`api gateway arn parts: ${JSON.stringify(apiGatewayArnParts)}`);
        // If the split created more than the expected number of parts, then the
        // resource path must have had one or more /'s in it. Recreate the resource path.
        let resourcePath = "";
        for (let i = API_GATEWAY_ARN_INDEXES.length - 1; i < apiGatewayArnParts.length; i += 1) {
            resourcePath += `/${apiGatewayArnParts[i]}`;
        }
        console.log(`resource path: ${JSON.stringify(resourcePath)}`);
        return {
            method: apiGatewayArnParts[METHOD_INDEX],
            resourcePath,
            apiOptions: {
                region: methodArnParts[REGION_INDEX],
                restApiId: apiGatewayArnParts[API_ID_INDEX],
                stage: apiGatewayArnParts[STAGE_INDEX],
            },
            awsAccountId: methodArnParts[ACCOUNT_ID_INDEX],
        };
    }
    getScope(parsedMethodArn) {
        const scopeConfig = process.env["SCOPE_CONFIG"];
        if (scopeConfig != undefined) {
            const conf = JSON.parse(scopeConfig);
            for (const path of Object.keys(conf)) {
                if (this.pathMatch(path, parsedMethodArn.resourcePath)) {
                    return conf[path];
                }
            }
        }
        return null;
    }
    getPersonaClient() {
        if (this.personaClient == null) {
            const personaConfig = {
                persona_host: process.env["PERSONA_HOST"],
                persona_scheme: process.env["PERSONA_SCHEME"],
                persona_port: process.env["PERSONA_PORT"],
                persona_oauth_route: process.env["PERSONA_OAUTH_ROUTE"],
            };
            this.personaClient = talis_node_1.persona.createClient(`${process.env["PERSONA_CLIENT_NAME"]} (lambda; NODE_ENV=${process.env["NODE_ENV"]})`, _.merge(personaConfig, {}));
        }
        return this.personaClient;
    }
    pathMatch(pathDefinition, path) {
        const pathDefinitionParts = pathDefinition.split("/");
        const pathParts = path.split("/");
        if (pathDefinitionParts.length !== pathParts.length) {
            return false;
        }
        for (let i = 0; i < pathDefinitionParts.length; i++) {
            const pathDefinitionSegment = pathDefinitionParts[i];
            const pathSegment = pathParts[i];
            if (pathDefinitionSegment.startsWith("{") &&
                pathDefinitionSegment.endsWith("}")) {
                // Matches path argument
            }
            else {
                // Should match directly
                if (pathDefinitionSegment !== pathSegment) {
                    return false;
                }
            }
        }
        return true;
    }
}
exports.PersonaAuthorizer = PersonaAuthorizer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGVyc29uYUF1dGhvcml6ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJQZXJzb25hQXV0aG9yaXplci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw0QkFBNEI7QUFDNUIsMkNBQW9EO0FBYXBELG9DQUFvQztBQUNwQyxFQUFFO0FBQ0YscUJBQXFCO0FBQ3JCLDZGQUE2RjtBQUM3RixvRUFBb0U7QUFDcEUsOEZBQThGO0FBQzlGLEVBQUU7QUFDRixFQUFFO0FBQ0YsTUFBTSxTQUFTLEdBQUcsQ0FBQyxDQUFDO0FBQ3BCLE1BQU0sU0FBUyxHQUFHLENBQUMsQ0FBQztBQUNwQixNQUFNLGFBQWEsR0FBRyxDQUFDLENBQUM7QUFDeEIsTUFBTSxZQUFZLEdBQUcsQ0FBQyxDQUFDO0FBQ3ZCLE1BQU0sZ0JBQWdCLEdBQUcsQ0FBQyxDQUFDO0FBQzNCLE1BQU0scUJBQXFCLEdBQUcsQ0FBQyxDQUFDO0FBRWhDLE1BQU0sa0JBQWtCLEdBQUc7SUFDekIsU0FBUztJQUNULFNBQVM7SUFDVCxhQUFhO0lBQ2IsWUFBWTtJQUNaLGdCQUFnQjtJQUNoQixxQkFBcUI7Q0FDdEIsQ0FBQztBQUVGLE1BQU0sWUFBWSxHQUFHLENBQUMsQ0FBQztBQUN2QixNQUFNLFdBQVcsR0FBRyxDQUFDLENBQUM7QUFDdEIsTUFBTSxZQUFZLEdBQUcsQ0FBQyxDQUFDO0FBQ3ZCLE1BQU0sbUJBQW1CLEdBQUcsQ0FBQyxDQUFDO0FBRTlCLE1BQU0sdUJBQXVCLEdBQUc7SUFDOUIsWUFBWTtJQUNaLFdBQVc7SUFDWCxZQUFZO0lBQ1osbUJBQW1CO0NBQ3BCLENBQUM7QUFFRixNQUFhLGlCQUFpQjtJQUs1QixZQUFZLEtBQVUsRUFBRSxPQUFZO1FBQ2xDLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBRXZCLElBQUksQ0FBQyxhQUFhLEdBQUcsU0FBUyxDQUFDO0lBQ2pDLENBQUM7SUFFRCxLQUFLLENBQUMsTUFBTTs7UUFDVixPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUUxQyxJQUFJLFFBQUMsSUFBSSxDQUFDLEtBQUssMENBQUUsT0FBTyxDQUFBLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLElBQUksSUFBSSxFQUFFO1lBQ3ZFLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLENBQUMsQ0FBQztZQUNsQyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1NBQzFDO1FBRUQsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ2pFLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLElBQUksQ0FBQyxTQUFTLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRXJFLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDN0MsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUUxQyxJQUFJLGNBQWMsR0FBRztZQUNuQixLQUFLLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FDZCxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUMsRUFDbkMsUUFBUSxFQUNSLEVBQUUsQ0FDSCxDQUFDLElBQUksRUFBRTtTQUNULENBQUM7UUFDRixJQUFJLEtBQUssSUFBSSxJQUFJLEVBQUU7WUFDakIsY0FBYyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsY0FBYyxFQUFFLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztTQUNyRDtRQUNELE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRWpFLE9BQU8sQ0FBQyxHQUFHLENBQ1Qsa0NBQWtDLEVBQ2xDLEdBQUcsZUFBZSxDQUFDLFlBQVksRUFBRSxDQUNsQyxDQUFDO1FBRUYsSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLElBQUksY0FBYyxDQUFDLEtBQUssQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQzlELE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUM7WUFDN0IsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztTQUMxQztRQUVELElBQUk7WUFDRixNQUFNLEtBQUssR0FBRyxNQUFNLElBQUksQ0FBQyxhQUFhLENBQUMsY0FBYyxDQUFDLENBQUM7WUFDdkQsTUFBTSxPQUFPLEdBQUc7Z0JBQ2QsWUFBWSxFQUFFLElBQUk7Z0JBQ2xCLE9BQU8sRUFBRTtvQkFDUCxRQUFRLEVBQUUsS0FBSyxDQUFDLEtBQUssQ0FBQztpQkFDdkI7YUFDRixDQUFDO1lBQ0YsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUN0QztRQUFDLE9BQU8sR0FBRyxFQUFFO1lBQ1osT0FBTyxDQUFDLEdBQUcsQ0FBQyx5QkFBeUIsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUU1QyxNQUFNLEtBQUssR0FBRyxHQUFpRCxDQUFDO1lBRWhFLElBQUksS0FBSyxDQUFDLEtBQUssS0FBSyxvQkFBTyxDQUFDLFVBQVUsQ0FBQyxrQkFBa0IsRUFBRTtnQkFDekQsTUFBTSxpQkFBaUIsR0FBRztvQkFDeEIsWUFBWSxFQUFFLEtBQUs7b0JBQ25CLE9BQU8sRUFBRTt3QkFDUCxXQUFXLEVBQUUsb0JBQW9CO3dCQUNqQyxRQUFRLEVBQUUsQ0FBQSxLQUFLLGFBQUwsS0FBSyx1QkFBTCxLQUFLLENBQUUsS0FBSyxFQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFO3FCQUNqRDtpQkFDRixDQUFDO2dCQUNGLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQzthQUNoRDtZQUVELE1BQU0sT0FBTyxHQUFHO2dCQUNkLFlBQVksRUFBRSxLQUFLO2dCQUNuQixPQUFPLEVBQUU7b0JBQ1AsUUFBUSxFQUFFLENBQUEsS0FBSyxhQUFMLEtBQUssdUJBQUwsS0FBSyxDQUFFLEtBQUssRUFBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRTtpQkFDakQ7YUFDRixDQUFDO1lBQ0YsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUN0QztJQUNILENBQUM7SUFFRCxhQUFhLENBQUMsY0FBbUI7UUFDL0IsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDdkMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxVQUFVLE9BQU8sRUFBRSxNQUFNO1lBQzFDLE1BQU0sQ0FBQyxhQUFhLENBQ2xCLGNBQWMsRUFDZCxDQUFDLEtBQVUsRUFBRSxFQUFPLEVBQUUsWUFBaUIsRUFBRSxFQUFFO2dCQUN6QyxJQUFJLEtBQUssRUFBRTtvQkFDVCxNQUFNLENBQUM7d0JBQ0wsS0FBSyxFQUFFLEtBQUs7d0JBQ1osS0FBSyxFQUFFLFlBQVk7cUJBQ3BCLENBQUMsQ0FBQztpQkFDSjtnQkFDRCxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDeEIsQ0FBQyxDQUNGLENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O09BcUJHO0lBQ0gsY0FBYyxDQUFDLFNBQWlCO1FBQzlCLE1BQU0sY0FBYyxHQUFHLFNBQVMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDNUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDbkUsSUFBSSxhQUFhLEdBQUcsY0FBYyxDQUFDLHFCQUFxQixDQUFDLENBQUM7UUFDMUQsd0VBQXdFO1FBQ3hFLGtGQUFrRjtRQUNsRixLQUNFLElBQUksS0FBSyxHQUFHLGtCQUFrQixDQUFDLE1BQU0sRUFDckMsS0FBSyxHQUFHLGNBQWMsQ0FBQyxNQUFNLEVBQzdCLEtBQUssSUFBSSxDQUFDLEVBQ1Y7WUFDQSxhQUFhLElBQUksSUFBSSxjQUFjLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztTQUM5QztRQUVELE1BQU0sa0JBQWtCLEdBQUcsYUFBYSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNwRCxPQUFPLENBQUMsR0FBRyxDQUFDLDBCQUEwQixJQUFJLENBQUMsU0FBUyxDQUFDLGtCQUFrQixDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRTVFLHdFQUF3RTtRQUN4RSxpRkFBaUY7UUFDakYsSUFBSSxZQUFZLEdBQUcsRUFBRSxDQUFDO1FBQ3RCLEtBQ0UsSUFBSSxDQUFDLEdBQUcsdUJBQXVCLENBQUMsTUFBTSxHQUFHLENBQUMsRUFDMUMsQ0FBQyxHQUFHLGtCQUFrQixDQUFDLE1BQU0sRUFDN0IsQ0FBQyxJQUFJLENBQUMsRUFDTjtZQUNBLFlBQVksSUFBSSxJQUFJLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7U0FDN0M7UUFDRCxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM5RCxPQUFPO1lBQ0wsTUFBTSxFQUFFLGtCQUFrQixDQUFDLFlBQVksQ0FBQztZQUN4QyxZQUFZO1lBQ1osVUFBVSxFQUFFO2dCQUNWLE1BQU0sRUFBRSxjQUFjLENBQUMsWUFBWSxDQUFDO2dCQUNwQyxTQUFTLEVBQUUsa0JBQWtCLENBQUMsWUFBWSxDQUFDO2dCQUMzQyxLQUFLLEVBQUUsa0JBQWtCLENBQUMsV0FBVyxDQUFDO2FBQ3ZDO1lBQ0QsWUFBWSxFQUFFLGNBQWMsQ0FBQyxnQkFBZ0IsQ0FBQztTQUMvQyxDQUFDO0lBQ0osQ0FBQztJQUVELFFBQVEsQ0FBQyxlQUEwQjtRQUNqQyxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQ2hELElBQUksV0FBVyxJQUFJLFNBQVMsRUFBRTtZQUM1QixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ3JDLEtBQUssTUFBTSxJQUFJLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDcEMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxlQUFlLENBQUMsWUFBWSxDQUFDLEVBQUU7b0JBQ3RELE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2lCQUNuQjthQUNGO1NBQ0Y7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCxnQkFBZ0I7UUFDZCxJQUFJLElBQUksQ0FBQyxhQUFhLElBQUksSUFBSSxFQUFFO1lBQzlCLE1BQU0sYUFBYSxHQUFHO2dCQUNwQixZQUFZLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUM7Z0JBQ3pDLGNBQWMsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDO2dCQUM3QyxZQUFZLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUM7Z0JBQ3pDLG1CQUFtQixFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMscUJBQXFCLENBQUM7YUFDeEQsQ0FBQztZQUVGLElBQUksQ0FBQyxhQUFhLEdBQUcsb0JBQU8sQ0FBQyxZQUFZLENBQ3ZDLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxzQkFBc0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUNyRixDQUFDLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRSxFQUFFLENBQUMsQ0FDM0IsQ0FBQztTQUNIO1FBRUQsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDO0lBQzVCLENBQUM7SUFFRCxTQUFTLENBQUMsY0FBc0IsRUFBRSxJQUFZO1FBQzVDLE1BQU0sbUJBQW1CLEdBQUcsY0FBYyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN0RCxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRWxDLElBQUksbUJBQW1CLENBQUMsTUFBTSxLQUFLLFNBQVMsQ0FBQyxNQUFNLEVBQUU7WUFDbkQsT0FBTyxLQUFLLENBQUM7U0FDZDtRQUVELEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxtQkFBbUIsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDbkQsTUFBTSxxQkFBcUIsR0FBRyxtQkFBbUIsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNyRCxNQUFNLFdBQVcsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFakMsSUFDRSxxQkFBcUIsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDO2dCQUNyQyxxQkFBcUIsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQ25DO2dCQUNBLHdCQUF3QjthQUN6QjtpQkFBTTtnQkFDTCx3QkFBd0I7Z0JBQ3hCLElBQUkscUJBQXFCLEtBQUssV0FBVyxFQUFFO29CQUN6QyxPQUFPLEtBQUssQ0FBQztpQkFDZDthQUNGO1NBQ0Y7UUFFRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7Q0FDRjtBQTdORCw4Q0E2TkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBfIGZyb20gXCJsb2Rhc2hcIjtcbmltcG9ydCB7IHBlcnNvbmEsIFBlcnNvbmFDbGllbnQgfSBmcm9tIFwidGFsaXMtbm9kZVwiO1xuXG50eXBlIFBhcnNlZEFybiA9IHtcbiAgbWV0aG9kOiBzdHJpbmc7XG4gIHJlc291cmNlUGF0aDogc3RyaW5nO1xuICBhcGlPcHRpb25zOiB7XG4gICAgcmVnaW9uOiBzdHJpbmc7XG4gICAgcmVzdEFwaUlkOiBzdHJpbmc7XG4gICAgc3RhZ2U6IHN0cmluZztcbiAgfTtcbiAgYXdzQWNjb3VudElkOiBzdHJpbmc7XG59O1xuXG4vLyBDb25zdGFudHMgdXNlZCBieSBwYXJzZU1ldGhvZEFybjpcbi8vXG4vLyBFeGFtcGxlIE1ldGhvZEFSTjpcbi8vICAgXCJhcm46YXdzOmV4ZWN1dGUtYXBpOjxSZWdpb24gaWQ+OjxBY2NvdW50IGlkPjo8QVBJIGlkPi88U3RhZ2U+LzxNZXRob2Q+LzxSZXNvdXJjZSBwYXRoPlwiXG4vLyBNZXRob2QgQVJOIEluZGV4OiAgMCAgIDEgICAyICAgICAgICAgICAzICAgICAgICAgICA0ICAgICAgICAgICAgNVxuLy8gQVBJIEdhdGV3YXkgQVJOIEluZGV4OiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDAgICAgICAgIDEgICAgICAgMiAgICAgICAgM1xuLy9cbi8vXG5jb25zdCBBUk5fSU5ERVggPSAwO1xuY29uc3QgQVdTX0lOREVYID0gMTtcbmNvbnN0IEVYRUNVVEVfSU5ERVggPSAyO1xuY29uc3QgUkVHSU9OX0lOREVYID0gMztcbmNvbnN0IEFDQ09VTlRfSURfSU5ERVggPSA0O1xuY29uc3QgQVBJX0dBVEVXQVlfQVJOX0lOREVYID0gNTtcblxuY29uc3QgTUVUSE9EX0FSTl9JTkRFWEVTID0gW1xuICBBUk5fSU5ERVgsXG4gIEFXU19JTkRFWCxcbiAgRVhFQ1VURV9JTkRFWCxcbiAgUkVHSU9OX0lOREVYLFxuICBBQ0NPVU5UX0lEX0lOREVYLFxuICBBUElfR0FURVdBWV9BUk5fSU5ERVgsXG5dO1xuXG5jb25zdCBBUElfSURfSU5ERVggPSAwO1xuY29uc3QgU1RBR0VfSU5ERVggPSAxO1xuY29uc3QgTUVUSE9EX0lOREVYID0gMjtcbmNvbnN0IFJFU09VUkNFX1BBVEhfSU5ERVggPSAzO1xuXG5jb25zdCBBUElfR0FURVdBWV9BUk5fSU5ERVhFUyA9IFtcbiAgQVBJX0lEX0lOREVYLFxuICBTVEFHRV9JTkRFWCxcbiAgTUVUSE9EX0lOREVYLFxuICBSRVNPVVJDRV9QQVRIX0lOREVYLFxuXTtcblxuZXhwb3J0IGNsYXNzIFBlcnNvbmFBdXRob3JpemVyIHtcbiAgZXZlbnQ6IGFueTtcbiAgY29udGV4dDogYW55O1xuICBwZXJzb25hQ2xpZW50OiBQZXJzb25hQ2xpZW50IHwgdW5kZWZpbmVkO1xuXG4gIGNvbnN0cnVjdG9yKGV2ZW50OiBhbnksIGNvbnRleHQ6IGFueSkge1xuICAgIHRoaXMuZXZlbnQgPSBldmVudDtcbiAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0O1xuXG4gICAgdGhpcy5wZXJzb25hQ2xpZW50ID0gdW5kZWZpbmVkO1xuICB9XG5cbiAgYXN5bmMgaGFuZGxlKCkge1xuICAgIGNvbnNvbGUubG9nKFwiUmVjZWl2ZWQgZXZlbnRcIiwgdGhpcy5ldmVudCk7XG5cbiAgICBpZiAoIXRoaXMuZXZlbnQ/LmhlYWRlcnMgfHwgdGhpcy5ldmVudC5oZWFkZXJzW1wiYXV0aG9yaXphdGlvblwiXSA9PSBudWxsKSB7XG4gICAgICBjb25zb2xlLmxvZyhcIk1pc3NpbmcgYXV0aCB0b2tlblwiKTtcbiAgICAgIHJldHVybiB0aGlzLmNvbnRleHQuZmFpbChcIlVuYXV0aG9yaXplZFwiKTtcbiAgICB9XG5cbiAgICBjb25zdCBwYXJzZWRNZXRob2RBcm4gPSB0aGlzLnBhcnNlTWV0aG9kQXJuKHRoaXMuZXZlbnQucm91dGVBcm4pO1xuICAgIGNvbnNvbGUubG9nKGBQYXJzZWQgTWV0aG9kIEFybjogJHtKU09OLnN0cmluZ2lmeShwYXJzZWRNZXRob2RBcm4pfWApO1xuXG4gICAgY29uc3Qgc2NvcGUgPSB0aGlzLmdldFNjb3BlKHBhcnNlZE1ldGhvZEFybik7XG4gICAgY29uc29sZS5sb2coYE1ldGhvZCBoYXMgc2NvcGU6ICR7c2NvcGV9YCk7XG5cbiAgICBsZXQgdmFsaWRhdGlvbk9wdHMgPSB7XG4gICAgICB0b2tlbjogXy5yZXBsYWNlKFxuICAgICAgICB0aGlzLmV2ZW50LmhlYWRlcnNbXCJhdXRob3JpemF0aW9uXCJdLFxuICAgICAgICBcIkJlYXJlclwiLFxuICAgICAgICBcIlwiXG4gICAgICApLnRyaW0oKSxcbiAgICB9O1xuICAgIGlmIChzY29wZSAhPSBudWxsKSB7XG4gICAgICB2YWxpZGF0aW9uT3B0cyA9IF8ubWVyZ2UodmFsaWRhdGlvbk9wdHMsIHsgc2NvcGUgfSk7XG4gICAgfVxuICAgIGNvbnNvbGUubG9nKGBWYWxpZGF0aW9uIG9wczogJHtKU09OLnN0cmluZ2lmeSh2YWxpZGF0aW9uT3B0cyl9YCk7XG5cbiAgICBjb25zb2xlLmxvZyhcbiAgICAgIFwidmFsaWRhdGluZyB0b2tlbiBhZ2FpbnN0IHJlcXVlc3RcIixcbiAgICAgIGAke3BhcnNlZE1ldGhvZEFybi5yZXNvdXJjZVBhdGh9YFxuICAgICk7XG5cbiAgICBpZiAoIXZhbGlkYXRpb25PcHRzLnRva2VuIHx8IHZhbGlkYXRpb25PcHRzLnRva2VuLmxlbmd0aCA9PT0gMCkge1xuICAgICAgY29uc29sZS5sb2coXCJ0b2tlbiBtaXNzaW5nXCIpO1xuICAgICAgcmV0dXJuIHRoaXMuY29udGV4dC5mYWlsKFwiVW5hdXRob3JpemVkXCIpO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBjb25zdCB0b2tlbiA9IGF3YWl0IHRoaXMudmFsaWRhdGVUb2tlbih2YWxpZGF0aW9uT3B0cyk7XG4gICAgICBjb25zdCBzdWNjZXNzID0ge1xuICAgICAgICBpc0F1dGhvcml6ZWQ6IHRydWUsXG4gICAgICAgIGNvbnRleHQ6IHtcbiAgICAgICAgICBjbGllbnRJZDogdG9rZW5bXCJzdWJcIl0sXG4gICAgICAgIH0sXG4gICAgICB9O1xuICAgICAgcmV0dXJuIHRoaXMuY29udGV4dC5zdWNjZWVkKHN1Y2Nlc3MpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgY29uc29sZS5sb2coXCJ0b2tlbiB2YWxpZGF0aW9uIGZhaWxlZFwiLCBlcnIpO1xuXG4gICAgICBjb25zdCBlcnJvciA9IGVyciBhcyB7IGVycm9yOiBhbnk7IHRva2VuOiBSZWNvcmQ8c3RyaW5nLCBhbnk+IH07XG5cbiAgICAgIGlmIChlcnJvci5lcnJvciA9PT0gcGVyc29uYS5lcnJvclR5cGVzLklOU1VGRklDSUVOVF9TQ09QRSkge1xuICAgICAgICBjb25zdCBpbnN1ZmZpY2llbnRTY29wZSA9IHtcbiAgICAgICAgICBpc0F1dGhvcml6ZWQ6IGZhbHNlLFxuICAgICAgICAgIGNvbnRleHQ6IHtcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBcIkluc3VmZmljaWVudCBTY29wZVwiLFxuICAgICAgICAgICAgY2xpZW50SWQ6IGVycm9yPy50b2tlbiA/IGVycm9yLnRva2VuW1wic3ViXCJdIDogXCJcIixcbiAgICAgICAgICB9LFxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gdGhpcy5jb250ZXh0LnN1Y2NlZWQoaW5zdWZmaWNpZW50U2NvcGUpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBmYWlsdXJlID0ge1xuICAgICAgICBpc0F1dGhvcml6ZWQ6IGZhbHNlLFxuICAgICAgICBjb250ZXh0OiB7XG4gICAgICAgICAgY2xpZW50SWQ6IGVycm9yPy50b2tlbiA/IGVycm9yLnRva2VuW1wic3ViXCJdIDogXCJcIixcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgICByZXR1cm4gdGhpcy5jb250ZXh0LnN1Y2NlZWQoZmFpbHVyZSk7XG4gICAgfVxuICB9XG5cbiAgdmFsaWRhdGVUb2tlbih2YWxpZGF0aW9uT3B0czogYW55KTogUHJvbWlzZTxSZWNvcmQ8c3RyaW5nLCBhbnk+PiB7XG4gICAgY29uc3QgY2xpZW50ID0gdGhpcy5nZXRQZXJzb25hQ2xpZW50KCk7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgIGNsaWVudC52YWxpZGF0ZVRva2VuKFxuICAgICAgICB2YWxpZGF0aW9uT3B0cyxcbiAgICAgICAgKGVycm9yOiBhbnksIG9rOiBhbnksIGRlY29kZWRUb2tlbjogYW55KSA9PiB7XG4gICAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICByZWplY3Qoe1xuICAgICAgICAgICAgICBlcnJvcjogZXJyb3IsXG4gICAgICAgICAgICAgIHRva2VuOiBkZWNvZGVkVG9rZW4sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmVzb2x2ZShkZWNvZGVkVG9rZW4pO1xuICAgICAgICB9XG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEJyZWFrIGRvd24gYW4gQVBJIGdhdGV3YXkgbWV0aG9kIEFSTiBpbnRvIGl0J3MgY29uc3RpdHVlbnQgcGFydHMuXG4gICAqIE1ldGhvZCBBUk5zIHRha2UgdGhlIGZvbGxvd2luZyBmb3JtYXQ6XG4gICAqXG4gICAqICAgYXJuOmF3czpleGVjdXRlLWFwaTo8UmVnaW9uIGlkPjo8QWNjb3VudCBpZD46PEFQSSBpZD4vPFN0YWdlPi88TWV0aG9kPi88UmVzb3VyY2UgcGF0aD5cbiAgICpcbiAgICogZS5nOlxuICAgKlxuICAgKiAgIGFybjphd3M6ZXhlY3V0ZS1hcGk6ZXUtd2VzdC0xOjEyMzphYmMvZGV2ZWxvcG1lbnQvR0VULzIvd29ya3NcbiAgICpcbiAgICogQHBhcmFtIG1ldGhvZEFybiB7c3RyaW5nfSBUaGUgbWV0aG9kIEFSTiBwcm92aWRlZCBieSB0aGUgZXZlbnQgaGFuZGVkIHRvIGEgTGFtYmRhIGZ1bmN0aW9uXG4gICAqIEByZXR1cm5zIHt7XG4gICAqICAgbWV0aG9kOiBzdHJpbmcsXG4gICAqICAgcmVzb3VyY2VQYXRoOiBzdHJpbmcsXG4gICAqICAgYXBpT3B0aW9uczoge1xuICAgKiAgICAgcmVnaW9uOiBzdHJpbmcsXG4gICAqICAgICByZXN0QXBpSWQ6IHN0cmluZyxcbiAgICogICAgIHN0YWdlOiBzdHJpbmdcbiAgICogICB9LFxuICAgKiAgIGF3c0FjY291bnRJZDogc3RyaW5nXG4gICAqICAgfX1cbiAgICovXG4gIHBhcnNlTWV0aG9kQXJuKG1ldGhvZEFybjogc3RyaW5nKTogUGFyc2VkQXJuIHtcbiAgICBjb25zdCBtZXRob2RBcm5QYXJ0cyA9IG1ldGhvZEFybi5zcGxpdChcIjpcIik7XG4gICAgY29uc29sZS5sb2coYE1ldGhvZCBBUk4gUGFydHM6ICR7SlNPTi5zdHJpbmdpZnkobWV0aG9kQXJuUGFydHMpfWApO1xuICAgIGxldCBhcGlHYXRld2F5QXJuID0gbWV0aG9kQXJuUGFydHNbQVBJX0dBVEVXQVlfQVJOX0lOREVYXTtcbiAgICAvLyBJZiB0aGUgc3BsaXQgY3JlYXRlZCBtb3JlIHRoYW4gdGhlIGV4cGVjdGVkIG51bWJlciBvZiBwYXJ0cywgdGhlbiB0aGVcbiAgICAvLyBhcGlHYXRld2F5QXJuIG11c3QgaGF2ZSBoYWQgb25lIG9yIG1vcmUgOidzIGluIGl0LiBSZWNyZWF0ZSB0aGUgYXBpR2F0ZXdheSBhcm4uXG4gICAgZm9yIChcbiAgICAgIGxldCBpbmRleCA9IE1FVEhPRF9BUk5fSU5ERVhFUy5sZW5ndGg7XG4gICAgICBpbmRleCA8IG1ldGhvZEFyblBhcnRzLmxlbmd0aDtcbiAgICAgIGluZGV4ICs9IDFcbiAgICApIHtcbiAgICAgIGFwaUdhdGV3YXlBcm4gKz0gYDoke21ldGhvZEFyblBhcnRzW2luZGV4XX1gO1xuICAgIH1cblxuICAgIGNvbnN0IGFwaUdhdGV3YXlBcm5QYXJ0cyA9IGFwaUdhdGV3YXlBcm4uc3BsaXQoXCIvXCIpO1xuICAgIGNvbnNvbGUubG9nKGBhcGkgZ2F0ZXdheSBhcm4gcGFydHM6ICR7SlNPTi5zdHJpbmdpZnkoYXBpR2F0ZXdheUFyblBhcnRzKX1gKTtcblxuICAgIC8vIElmIHRoZSBzcGxpdCBjcmVhdGVkIG1vcmUgdGhhbiB0aGUgZXhwZWN0ZWQgbnVtYmVyIG9mIHBhcnRzLCB0aGVuIHRoZVxuICAgIC8vIHJlc291cmNlIHBhdGggbXVzdCBoYXZlIGhhZCBvbmUgb3IgbW9yZSAvJ3MgaW4gaXQuIFJlY3JlYXRlIHRoZSByZXNvdXJjZSBwYXRoLlxuICAgIGxldCByZXNvdXJjZVBhdGggPSBcIlwiO1xuICAgIGZvciAoXG4gICAgICBsZXQgaSA9IEFQSV9HQVRFV0FZX0FSTl9JTkRFWEVTLmxlbmd0aCAtIDE7XG4gICAgICBpIDwgYXBpR2F0ZXdheUFyblBhcnRzLmxlbmd0aDtcbiAgICAgIGkgKz0gMVxuICAgICkge1xuICAgICAgcmVzb3VyY2VQYXRoICs9IGAvJHthcGlHYXRld2F5QXJuUGFydHNbaV19YDtcbiAgICB9XG4gICAgY29uc29sZS5sb2coYHJlc291cmNlIHBhdGg6ICR7SlNPTi5zdHJpbmdpZnkocmVzb3VyY2VQYXRoKX1gKTtcbiAgICByZXR1cm4ge1xuICAgICAgbWV0aG9kOiBhcGlHYXRld2F5QXJuUGFydHNbTUVUSE9EX0lOREVYXSxcbiAgICAgIHJlc291cmNlUGF0aCxcbiAgICAgIGFwaU9wdGlvbnM6IHtcbiAgICAgICAgcmVnaW9uOiBtZXRob2RBcm5QYXJ0c1tSRUdJT05fSU5ERVhdLFxuICAgICAgICByZXN0QXBpSWQ6IGFwaUdhdGV3YXlBcm5QYXJ0c1tBUElfSURfSU5ERVhdLFxuICAgICAgICBzdGFnZTogYXBpR2F0ZXdheUFyblBhcnRzW1NUQUdFX0lOREVYXSxcbiAgICAgIH0sXG4gICAgICBhd3NBY2NvdW50SWQ6IG1ldGhvZEFyblBhcnRzW0FDQ09VTlRfSURfSU5ERVhdLFxuICAgIH07XG4gIH1cblxuICBnZXRTY29wZShwYXJzZWRNZXRob2RBcm46IFBhcnNlZEFybikge1xuICAgIGNvbnN0IHNjb3BlQ29uZmlnID0gcHJvY2Vzcy5lbnZbXCJTQ09QRV9DT05GSUdcIl07XG4gICAgaWYgKHNjb3BlQ29uZmlnICE9IHVuZGVmaW5lZCkge1xuICAgICAgY29uc3QgY29uZiA9IEpTT04ucGFyc2Uoc2NvcGVDb25maWcpO1xuICAgICAgZm9yIChjb25zdCBwYXRoIG9mIE9iamVjdC5rZXlzKGNvbmYpKSB7XG4gICAgICAgIGlmICh0aGlzLnBhdGhNYXRjaChwYXRoLCBwYXJzZWRNZXRob2RBcm4ucmVzb3VyY2VQYXRoKSkge1xuICAgICAgICAgIHJldHVybiBjb25mW3BhdGhdO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgZ2V0UGVyc29uYUNsaWVudCgpIHtcbiAgICBpZiAodGhpcy5wZXJzb25hQ2xpZW50ID09IG51bGwpIHtcbiAgICAgIGNvbnN0IHBlcnNvbmFDb25maWcgPSB7XG4gICAgICAgIHBlcnNvbmFfaG9zdDogcHJvY2Vzcy5lbnZbXCJQRVJTT05BX0hPU1RcIl0sXG4gICAgICAgIHBlcnNvbmFfc2NoZW1lOiBwcm9jZXNzLmVudltcIlBFUlNPTkFfU0NIRU1FXCJdLFxuICAgICAgICBwZXJzb25hX3BvcnQ6IHByb2Nlc3MuZW52W1wiUEVSU09OQV9QT1JUXCJdLFxuICAgICAgICBwZXJzb25hX29hdXRoX3JvdXRlOiBwcm9jZXNzLmVudltcIlBFUlNPTkFfT0FVVEhfUk9VVEVcIl0sXG4gICAgICB9O1xuXG4gICAgICB0aGlzLnBlcnNvbmFDbGllbnQgPSBwZXJzb25hLmNyZWF0ZUNsaWVudChcbiAgICAgICAgYCR7cHJvY2Vzcy5lbnZbXCJQRVJTT05BX0NMSUVOVF9OQU1FXCJdfSAobGFtYmRhOyBOT0RFX0VOVj0ke3Byb2Nlc3MuZW52W1wiTk9ERV9FTlZcIl19KWAsXG4gICAgICAgIF8ubWVyZ2UocGVyc29uYUNvbmZpZywge30pXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnBlcnNvbmFDbGllbnQ7XG4gIH1cblxuICBwYXRoTWF0Y2gocGF0aERlZmluaXRpb246IHN0cmluZywgcGF0aDogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgY29uc3QgcGF0aERlZmluaXRpb25QYXJ0cyA9IHBhdGhEZWZpbml0aW9uLnNwbGl0KFwiL1wiKTtcbiAgICBjb25zdCBwYXRoUGFydHMgPSBwYXRoLnNwbGl0KFwiL1wiKTtcblxuICAgIGlmIChwYXRoRGVmaW5pdGlvblBhcnRzLmxlbmd0aCAhPT0gcGF0aFBhcnRzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGF0aERlZmluaXRpb25QYXJ0cy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgcGF0aERlZmluaXRpb25TZWdtZW50ID0gcGF0aERlZmluaXRpb25QYXJ0c1tpXTtcbiAgICAgIGNvbnN0IHBhdGhTZWdtZW50ID0gcGF0aFBhcnRzW2ldO1xuXG4gICAgICBpZiAoXG4gICAgICAgIHBhdGhEZWZpbml0aW9uU2VnbWVudC5zdGFydHNXaXRoKFwie1wiKSAmJlxuICAgICAgICBwYXRoRGVmaW5pdGlvblNlZ21lbnQuZW5kc1dpdGgoXCJ9XCIpXG4gICAgICApIHtcbiAgICAgICAgLy8gTWF0Y2hlcyBwYXRoIGFyZ3VtZW50XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBTaG91bGQgbWF0Y2ggZGlyZWN0bHlcbiAgICAgICAgaWYgKHBhdGhEZWZpbml0aW9uU2VnbWVudCAhPT0gcGF0aFNlZ21lbnQpIHtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxufVxuIl19